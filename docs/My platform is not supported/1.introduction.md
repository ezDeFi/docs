# Introduction

1. Đăng ký tài khoản tại https://merchant.ezdefi.com

2. Truy cập phần Site Management để tạo Site, sau đó chọn loại coin để chấp nhận thanh toán tại đó. Hãy cấu hình và lưu lại api key, siteid và gateway api url (default: https://merchant-api.ezdefi.com/api) trong trang config của bạn để sử dụng lại sau này
Cách thức giao tiếp với api_url: đặt giá trị header của http/https request là apikey: YOUR_API_KEY


3. Luồng hoạt động trong trang customer
- lấy dữ liệu đã config trên merchant bằng API: {method: get, url: api_url + '/website/:siteId'} từ đó hãy hiển thị cho người dùng thấy các coins đã coinfig
- sau khi người dùng đã chọn được coin thì hãy tạo payment cho họ:
    - gọi api {method: get, url: api_url + '/website/:siteId'} và từ coin_id mà người dùng chọn hãy xác định các tham số mà bạn đã config trên merchant với coin đó
    - gọi APi {method: get, url: api_url + '/token/exchange/USD:BTC} để lấy tỉ giá của cặp tiền (origin currency : cryptocurrency) khi cần
    - gọi api {method: get, url: api_url + '/payment/create', params: {
            'uoid'     => "orderid-flag" (với flag = 1 nếu sử dụng phương thức anywallet, flag = 0 nếu thanh toán bằng ví ezdefi),
                'amountId' => true|false  (true: nếu sử dụng phương thức anywallet, false nếu thanh toán bằng ví ezdefi) (*)
                    'coinId'   => coinId (coin_id mà người dùng chọn),
                   'value'    => value (nếu nếu payment này sử dụng phương thức anywallet thì hãy gửi lên lượng coin của đơn hàng này (BTC|ETH|TRX|...), nếu payment sử dụng ezdefiwallet thì chỉ cần gửi số tiền của order (USD|VND|...)),
                   'to'       => walletAddress (địa chỉ ví nhận tiền lưu trên merchant.ezdefi.com),
                   'currency' => base_currency:cryptocurrency (vd: USD:BTC) (nếu là phương thức anywallet thì hãy gửi cryptocurrency:cryptocurrency vd: BTC:BTC),
                   'safedist' => giá trị safedist (block confirmation) đã lưu trên merchant.ezdefi.com,
                   'duration' => duration (giá trị duration lưu trên merchant, hãy đổi giá trị này ra giây),
                   'callback' => callback url (khi payment được thanh toán merchant sẽ gọi về url này để bạn có thể biết được đơn hàng đã thanh toán thành công, hãy sử lý order trong url đó)
        } }
    - sau khi đã tạo được payment trên gateway hãy hiển thị order cùng với QR code lấy từ API trả về và show cho người dùng thanh toán
    
- Bên phía clent bạn nên có 1 hành động để xác định xem order đã thanh toán hay chưa để thông báo cho client (có thể dùng socket hoặc gọi liên tục lên server để kiểm tra)
- khi payment được thanh toán thành công, gateway sẽ gọi về callback url của bạn như đã nói ở trên. Khi đó hãy kiểm tra lại tính đúng đắn của payment đó, tránh trường hợp kẻ xấu giả mạo và gọi đến callback đó
gọi đến api {method: get, url: api_url + `/payment/get?paymentid=${paymentid}`} (với paymentid là tham số mà gateway truyền vào khi gọi đến callback) để kiểm tra payment có thực sự được thanh toán hay không


(*) hiện tại ezdefi gateway đang hỗ trợ 2 cơ chế thanh toán:
- sử dụng ví của ezdefi
- sử dụng bất kỳ ví nào (any anywallet) dựa vào amount_id (amount chính là số tiền người dùng phải trả cho đơn hàng, gateway sẽ tính toán và trả về amount_id duy nhất và sát với giá trị của đơn hàng nhất (sấp sỉ 0) )

- trong trường hợp người dùng sử dụng phương thức any wallet để thanh toán, có thể sẽ có trường hợp người dùng gửi nhầm amount_id.
Vậy nên chúng tôi sẽ kiểm tra những trường hợp như vậy và gửi về trang web của bạn 1 exception. Để làm vậy hãy cho chúng tôi biết url của mà bạn xử lý exception đó bằng cách gọi API sau:
{method: put, url: api_url + "/website/update_callback", params: {callback, websiteId}}

* ngoài ra còn một số api sau bạn có thể dùng
- Quy đổi giá trị của đơn hàng sang các loại tiền điện tử {method: get, url: `/token/exchanges?amount=${amount}&from=${originCurrency}&to=${symbols}`} với amount là giá của đơn hàng, originCurrency là loại tiền đang áp dụng trên trang web của bạn (vd: USD), symbols là các coin mà bạn muốn quy đổi (vd: 'btc,eth,nty')
- lấy thông tin của 1 transaction {method: get, url: `/transaction/get?id=${id}`} như ở phần đầu đã đề cập, khi người dùng nhập nhầm amount_id thì gateway sẽ gọi về calback mà bạn đã lưu trước đó cùng với tham số id.
hãy dùng api này để xác minh tính đúng đắn của transaction, tránh trường hợp hacker lợi dụng.
